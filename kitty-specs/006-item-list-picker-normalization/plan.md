# Implementation Plan: Item List Picker Normalization

**Branch**: `main` | **Date**: 2026-02-11 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `kitty-specs/006-item-list-picker-normalization/spec.md`

## Summary

Consolidate `SharedItemPicker` (501 lines) into `SharedItemsList` (1,342 lines) by adding a `picker` mode prop and extracting all picker-specific logic into a `usePickerMode` custom hook. This eliminates duplicate grouping/selection logic, fixes grouped-item selection bugs, and ensures all item list rendering flows through one component. Migration is staged across 4 work packages to contain regression risk.

## Technical Context

**Language/Version**: TypeScript 5.x, React Native (Expo)
**Primary Dependencies**: React Native, Expo Router, React Native Firebase
**Storage**: Firestore (offline-first with fire-and-forget writes)
**Testing**: Manual testing across both consumers (no automated UI test suite)
**Target Platform**: iOS (primary), Android
**Project Type**: Mobile
**Performance Goals**: 60 fps list scrolling, instant response on item selection
**Constraints**: Offline-capable; no awaited Firestore writes in UI; all picker interactions must be snappy
**Scale/Scope**: ~2 consumers to migrate, ~4 files modified, ~1 file created, ~1 file deleted

## Constitution Check

*No constitution file found. Skipped.*

## Project Structure

### Documentation (this feature)

```
kitty-specs/006-item-list-picker-normalization/
├── plan.md              # This file
├── research.md          # Component analysis, decision log, hook design
├── spec.md              # Feature specification (8 FRs, 4 scenarios)
├── checklists/          # Requirements checklist
└── tasks.md             # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (affected files)

```
src/
├── hooks/
│   └── usePickerMode.ts           # NEW — picker-specific hook
├── components/
│   ├── SharedItemsList.tsx         # MODIFIED — add picker props, integrate hook
│   ├── SharedItemPicker.tsx        # DELETED (after migration complete)
│   ├── ItemPickerControlBar.tsx    # KEPT — reused by SharedItemsList picker mode
│   ├── SpaceDetailContent.tsx      # MODIFIED — migrate from SharedItemPicker
│   ├── GroupedItemCard.tsx         # UNCHANGED
│   ├── ItemCard.tsx                # UNCHANGED
│   └── index.ts                    # MODIFIED — remove SharedItemPicker export
app/
└── transactions/
    └── [id]/
        └── index.tsx               # MODIFIED — migrate from SharedItemPicker
```

## Architecture: `usePickerMode` Hook

### Why a Hook

SharedItemsList is already 1,342 lines. Previous component absorptions (feature 005) caused 4 documented regressions. Isolating picker logic in a hook:
- Keeps SharedItemsList's render function from growing significantly
- Makes picker logic independently testable
- Provides a clean boundary: SharedItemsList calls the hook and spreads results

### Hook API

**File:** `src/hooks/usePickerMode.ts`

```typescript
// --- Input ---
type UsePickerModeConfig = {
  enabled: boolean;                         // picker prop value
  items: Array<ScopedItem | Item>;          // visible items (post-search/filter)
  eligibilityCheck?: ItemEligibilityCheck;  // from spec FR-1
  onAddSingle?: (item: ScopedItem | Item) => void | Promise<void>;
  addedIds?: Set<string>;
  selectedIds: string[];                    // from manager (array form)
  setItemSelected: (id: string, next: boolean) => void;
  setGroupSelection: (ids: string[], next: boolean) => void;
};

// --- Output ---
type UsePickerModeReturn = {
  // Derived state
  eligibleIds: string[];
  allEligibleSelected: boolean;

  // Handlers
  handleSelectAll: () => void;

  // Props factories (return Partial<ItemCardProps> overrides)
  getPickerItemProps: (
    item: ScopedItem | Item,
    isSelected: boolean
  ) => Partial<ItemCardProps>;

  getPickerGroupProps: (
    groupItems: Array<ScopedItem | Item>,
    groupIds: string[]
  ) => {
    onPress: (() => void) | undefined;
    onSelectedChange: ((next: boolean) => void) | undefined;
    selected: boolean;
  };

  // Add button renderer
  renderAddButton: (item: ScopedItem | Item, locked: boolean) => React.ReactNode | undefined;
};
```

### How SharedItemsList Consumes It

```typescript
// In SharedItemsList component body:
const pickerMode = usePickerMode({
  enabled: picker ?? false,
  items,
  eligibilityCheck,
  onAddSingle,
  addedIds,
  selectedIds,
  setItemSelected,
  setGroupSelection,
});

// In control bar rendering:
{picker ? (
  <ItemPickerControlBar
    onSelectAll={pickerMode.handleSelectAll}
    allSelected={pickerMode.allEligibleSelected}
    hasItems={pickerMode.eligibleIds.length > 0}
    // ...
  />
) : !embedded ? (
  <ItemsListControlBar ... />
) : null}

// In item rendering (both embedded map and FlatList paths):
const itemProps = picker
  ? pickerMode.getPickerItemProps(item, isSelected)
  : { onPress: () => handleOpenItem(id), onBookmarkPress, onStatusPress, menuItems };

<ItemCard {...baseProps} {...itemProps} />
```

### What `getPickerItemProps` Returns

For each item, computes and returns:
- `onPress`: toggles selection (not navigation) — `undefined` if ineligible
- `onSelectedChange`: toggles selection — `undefined` if ineligible
- `headerAction`: Add button or Added badge (from `renderAddButton`)
- `style`: `{ opacity: 0.5 }` if ineligible
- `onBookmarkPress`: `undefined` (suppressed in picker mode)
- `onStatusPress`: `undefined` (suppressed in picker mode)
- `menuItems`: `undefined` (suppressed in picker mode)

### What `getPickerGroupProps` Returns

For each group, computes:
- `eligibleGroupIds`: items passing `isEligible` and not in `addedIds`
- `onPress`: toggles group selection for eligible items — `undefined` if no eligible items
- `onSelectedChange`: same as `onPress` but receives boolean
- `selected`: true when all eligible items in group are selected

## Migration Strategy

### Stage 1 (WP01): Hook + Props

**Goal:** Add picker infrastructure without changing any consumer.

**Changes:**
1. Create `src/hooks/usePickerMode.ts` with full hook implementation
2. Add picker props to `SharedItemsList` type definition (all optional, no effect when absent)
3. Integrate hook call in SharedItemsList (gated on `picker={true}`)
4. Add conditional `ItemPickerControlBar` rendering
5. Modify item/group rendering to use hook output when `picker={true}`

**Validation:** Existing standalone and embedded mode behavior unchanged. No consumers use `picker` yet.

### Stage 2 (WP02): Migrate SpaceDetailContent

**Goal:** Replace `SharedItemPicker` usage in SpaceDetailContent.

**Changes:**
1. Extract tab bar JSX from SharedItemPicker into SpaceDetailContent (or small `PickerTabBar` component)
2. Replace `useState<string[]>` picker selection with `useItemsManager` instance
3. Replace `<SharedItemPicker>` with `<SharedItemsList embedded={true} picker={true} manager={pickerManager} ...>`
4. Wire eligibility check, onAddSingle, addedIds, onAddSelected through new props

**Validation:** Space detail picker works identically — tabs, search, single add, bulk add, eligibility, added badges all functional.

### Stage 3 (WP03): Migrate TransactionDetailScreen

**Goal:** Replace `SharedItemPicker` usage in TransactionDetailScreen.

**Changes:**
1. Extract tab bar JSX into TransactionDetailScreen
2. Replace `useState<string[]>` with `useItemsManager` instance
3. Replace `<SharedItemPicker>` with `<SharedItemsList embedded={true} picker={true} ...>`
4. Wire eligibility check and onAddSelected (no onAddSingle or addedIds for this consumer)

**Validation:** Transaction detail picker works identically — dynamic tabs, bulk add, eligibility, conflict handling all functional.

### Stage 4 (WP04): Delete SharedItemPicker

**Goal:** Remove dead code.

**Changes:**
1. Delete `src/components/SharedItemPicker.tsx`
2. Remove `SharedItemPicker` and `ItemEligibilityCheck` exports from `src/components/index.ts`
3. Move `ItemEligibilityCheck` type to `src/hooks/usePickerMode.ts` (or shared types file)
4. Verify no remaining imports

**Validation:** Clean build with no dead code references.

## Key Design Decisions

| Decision | Choice | Why |
|----------|--------|-----|
| Extraction pattern | Custom hook (`usePickerMode`) | Prevents god component; isolates picker state derivation |
| Migration approach | 4 staged work packages | Contains regression risk; each stage independently testable |
| Selection state | Consumers adopt `useItemsManager` | Proven pattern; Set<string> for O(1) lookups |
| Grouping key | Composite `name::sku::source` | More precise than name-only; avoids incorrect grouping |
| Tab handling | Stays in parent components | Consumer-specific logic; keeps SharedItemsList focused |
| Control bar | Reuse `ItemPickerControlBar` as-is | Different layout from `ItemsListControlBar`; 150 lines, well-tested |
| Leaf components | No changes to ItemCard/GroupedItemCard | headerAction flows through existing `{...item}` spread |

## Files Changed per Work Package

### WP01: Hook + Props
| File | Change |
|------|--------|
| `src/hooks/usePickerMode.ts` | **NEW** — ~150 lines |
| `src/components/SharedItemsList.tsx` | **MODIFIED** — add picker props, import hook, conditional rendering |

### WP02: SpaceDetailContent Migration
| File | Change |
|------|--------|
| `src/components/SpaceDetailContent.tsx` | **MODIFIED** — replace SharedItemPicker with SharedItemsList picker mode |

### WP03: TransactionDetailScreen Migration
| File | Change |
|------|--------|
| `app/transactions/[id]/index.tsx` | **MODIFIED** — replace SharedItemPicker with SharedItemsList picker mode |

### WP04: Cleanup
| File | Change |
|------|--------|
| `src/components/SharedItemPicker.tsx` | **DELETED** |
| `src/components/index.ts` | **MODIFIED** — remove exports |
| `src/hooks/usePickerMode.ts` | **MODIFIED** — move `ItemEligibilityCheck` type here |

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Non-picker mode regressions | Hook returns no-ops when `enabled=false`; all picker props are optional with `undefined` defaults |
| Selection state sync bugs | Adapter pattern already proven; test Set→Array bridge during WP02 |
| Grouped item body-tap regression | Hook's `getPickerGroupProps` centralizes logic; explicit test per Scenario 3 |
| Tab bar styling mismatch | Extract tab bar JSX from SharedItemPicker directly; styles are inline and self-contained |
| Performance (hook overhead) | All derivations memoized; hook short-circuits when `enabled=false` |

## Quickstart

For implementers, the critical files to understand before starting:

1. **[spec.md](spec.md)** — 8 functional requirements with code examples
2. **[research.md](research.md)** — Component analysis, hook design, decision log
3. **`src/components/SharedItemsList.tsx`** — The target component (1,342 lines, dual-mode)
4. **`src/components/SharedItemPicker.tsx`** — The source component being absorbed (501 lines)
5. **`src/hooks/useItemsManager.ts`** — Selection state management hook
6. **`src/components/ItemPickerControlBar.tsx`** — Picker control bar (reused as-is)

Start with WP01 (hook + props). Do not proceed to consumer migration until picker mode renders correctly with test data.
