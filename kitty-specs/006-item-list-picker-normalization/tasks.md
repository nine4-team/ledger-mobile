# Work Packages: Item List Picker Normalization

**Inputs**: Design documents from `/kitty-specs/006-item-list-picker-normalization/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md (hook design, decision log)

**Tests**: Not required ‚Äî manual testing across both consumers.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: usePickerMode Hook + SharedItemsList Integration (Priority: P0) üéØ MVP

**Goal**: Create the `usePickerMode` hook and integrate picker-mode rendering into SharedItemsList. No consumers changed ‚Äî existing behavior unchanged.
**Independent Test**: SharedItemsList renders identically in standalone and embedded modes. Picker props exist but are unused. No regressions.
**Prompt**: `/tasks/WP01-picker-mode-hook-and-integration.md`
**Estimated Prompt Size**: ~450 lines

### Included Subtasks
- [x] T001 Create `src/hooks/usePickerMode.ts` ‚Äî type definitions (`ItemEligibilityCheck`, `UsePickerModeConfig`, `UsePickerModeReturn`)
- [x] T002 Implement `usePickerMode` hook logic ‚Äî `eligibleIds`, `allEligibleSelected`, `handleSelectAll`, `getPickerItemProps`, `getPickerGroupProps`, `renderAddButton`
- [x] T003 Add picker mode props to `SharedItemsListProps` in `src/components/SharedItemsList.tsx`
- [x] T004 Integrate `usePickerMode` hook call + conditional `ItemPickerControlBar` rendering in SharedItemsList
- [x] T005 Modify item card + group card rendering for picker mode (both embedded map + standalone FlatList paths)
- [x] T006 Add loading/error state rendering for picker mode (`outsideLoading`, `outsideError`)

### Implementation Notes
- Hook must short-circuit when `enabled === false` (zero overhead in non-picker mode).
- The hook's `setGroupSelection` param comes from SharedItemsList's existing internal adapter (line 248), not from `useItemsManager` directly. No changes to `useItemsManager` needed.
- Both embedded (View + map, ~lines 985-1110) and standalone (FlatList, ~lines 1111-1244) paths need picker prop spreading.
- `getPickerItemProps` returns overrides: `onPress` (toggle selection), `onSelectedChange`, `headerAction` (Add/Added badge), `style` (opacity for ineligible), and suppresses bookmark/status/menu.
- `getPickerGroupProps` filters eligible items per group, computes group selection state, returns `onPress`/`onSelectedChange`/`selected`.
- `ItemPickerControlBar` rendered when `picker={true}` even in embedded mode (unlike non-picker embedded which hides controls).

### Parallel Opportunities
- T001 and T003 can proceed in parallel (different files: hook types vs. component props).
- T005 and T006 are independent rendering concerns.

### Dependencies
- None (starting package).

### Risks & Mitigations
- **Non-picker regression**: Hook returns no-ops when disabled; all picker props are optional with undefined defaults.
- **Dual-path rendering**: Both embedded map and FlatList paths must be updated ‚Äî miss one and picker mode partially breaks. Prompt includes exact line ranges.
- **Performance**: All hook derivations memoized; eligibleIds computed once per render.

---

## Work Package WP02: Migrate SpaceDetailContent (Priority: P0)

**Goal**: Replace `SharedItemPicker` usage in SpaceDetailContent with `SharedItemsList` in picker mode. Full picker features: onAddSingle, addedIds, 2 tabs, eligibility.
**Independent Test**: Space detail picker works identically ‚Äî tabs, search, single add, bulk add, eligibility checks, "Added" badges all functional.
**Prompt**: `/tasks/WP02-migrate-space-detail.md`
**Estimated Prompt Size**: ~350 lines

### Included Subtasks
- [ ] T007 Add `useItemsManager` instance + manager adapter for picker selection state in `src/components/SpaceDetailContent.tsx`
- [ ] T008 Build tab bar in SpaceDetailContent (extract pattern from SharedItemPicker's existing tab rendering)
- [ ] T009 Replace `<SharedItemPicker>` with `<SharedItemsList embedded={true} picker={true}>` and wire all props
- [ ] T010 Handle tab change (`clearSelection`), loading/error states, and remove SharedItemPicker import

### Implementation Notes
- Replace `useState<string[]>` for picker selection (lines 152-154) with `useItemsManager` instance.
- Tab bar is ~60 lines of JSX ‚Äî extract from SharedItemPicker's pattern (lines 254-317) and render inline.
- Wire: eligibilityCheck (isEligible, getStatusLabel), onAddSingle (handleAddSingleItem), addedIds (spaceItemIds), onAddSelected (handleAddSelectedItems).
- Tab change calls `pickerManager.clearSelection()` instead of `setPickerSelectedIds([])`.

### Parallel Opportunities
- T007 (state setup) and T008 (tab bar) can be developed concurrently.

### Dependencies
- Depends on WP01 (picker mode props and hook must exist).

### Risks & Mitigations
- **Selection state bridge**: useItemsManager uses Set<string>, SharedItemsList's manager interface uses arrays. Adapter pattern already proven (see research.md D3).
- **Tab bar styling**: Extract tab JSX directly from SharedItemPicker ‚Äî styles are inline and self-contained.

---

## Work Package WP03: Migrate TransactionDetailScreen (Priority: P0)

**Goal**: Replace `SharedItemPicker` usage in TransactionDetailScreen with `SharedItemsList` in picker mode. Bulk-only mode (no onAddSingle/addedIds), dynamic 2-3 tabs.
**Independent Test**: Transaction detail picker works identically ‚Äî dynamic tabs (suggested/project/outside), bulk add, eligibility, conflict handling all functional.
**Prompt**: `/tasks/WP03-migrate-transaction-detail.md`
**Estimated Prompt Size**: ~300 lines

### Included Subtasks
- [x] T011 Add `useItemsManager` instance + manager adapter for picker selection state in `app/transactions/[id]/index.tsx`
- [x] T012 Build tab bar in TransactionDetailScreen (dynamic 2-3 tabs: suggested + optional project + outside)
- [x] T013 Replace `<SharedItemPicker>` with `<SharedItemsList embedded={true} picker={true}>` and wire all props

### Implementation Notes
- This consumer does NOT use `onAddSingle` or `addedIds` ‚Äî bulk selection only.
- Dynamic tab computation: 'suggested' always, 'project' when projectId exists, 'outside' always (lines 283-290).
- Wire: eligibilityCheck (isEligible by transactionId, getStatusLabel), onAddSelected (handleAddSelectedItems).
- Conflict handling via `showItemConflictDialog` stays in the handler ‚Äî no changes needed.

### Parallel Opportunities
- WP03 can run in parallel with WP02 (different files, both depend only on WP01).

### Dependencies
- Depends on WP01 (picker mode props and hook must exist).

### Risks & Mitigations
- **Dynamic tab count**: Tab bar must handle 2 or 3 tabs based on projectId. Extract logic from existing pickerTabOptions computation.
- **Conflict dialog flow**: handleAddSelectedItems already handles conflicts ‚Äî no changes needed, just ensure it's wired correctly.

---

## Work Package WP04: Cleanup & Dead Code Removal (Priority: P1)

**Goal**: Remove SharedItemPicker and clean up all references. Zero dead code.
**Independent Test**: Clean build with no TypeScript errors related to SharedItemPicker. No remaining imports.
**Prompt**: `/tasks/WP04-cleanup-shared-item-picker.md`
**Estimated Prompt Size**: ~200 lines

### Included Subtasks
- [ ] T014 Delete `src/components/SharedItemPicker.tsx`
- [ ] T015 [P] Update barrel exports in `src/components/index.ts` ‚Äî remove `SharedItemPicker` export (line 35), keep `ItemPickerControlBar` export (line 36)
- [ ] T016 Verify no remaining imports of `SharedItemPicker` across codebase + ensure `ItemEligibilityCheck` type is exported from `src/hooks/usePickerMode.ts`

### Implementation Notes
- `ItemPickerControlBar` is **kept** ‚Äî now consumed by SharedItemsList directly.
- `ItemEligibilityCheck` type must be available for consumers. It should be exported from `usePickerMode.ts` (already defined there in WP01).
- Grep for `SharedItemPicker` across all files to catch any stale imports.

### Parallel Opportunities
- T014 and T015 can proceed in parallel (different files).

### Dependencies
- Depends on WP02 and WP03 (both consumers must be migrated before deletion).

### Risks & Mitigations
- **Stale imports**: Run codebase-wide search before deletion to catch any missed references.
- **Type re-export**: Consumers importing `ItemEligibilityCheck` from `SharedItemPicker` must be updated to import from `usePickerMode`.

---

## Dependency & Execution Summary

- **Sequence**: WP01 ‚Üí (WP02 ‚à• WP03) ‚Üí WP04
- **Parallelization**: WP02 and WP03 can run in parallel after WP01 completes (different files, same dependency).
- **MVP Scope**: WP01 + WP02 constitute the minimal useful release (Space detail is the primary picker consumer with the most features).

```
WP01 (hook + integration)
  ‚îú‚îÄ‚îÄ WP02 (SpaceDetailContent migration) ‚îÄ‚îÄ‚îê
  ‚îî‚îÄ‚îÄ WP03 (TransactionDetail migration)  ‚îÄ‚îÄ‚î§
                                             ‚îî‚îÄ‚îÄ WP04 (cleanup)
```

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001       | Create usePickerMode.ts type definitions | WP01 | P0 | Yes |
| T002       | Implement usePickerMode hook logic | WP01 | P0 | No |
| T003       | Add picker props to SharedItemsListProps | WP01 | P0 | Yes |
| T004       | Integrate hook + conditional ItemPickerControlBar | WP01 | P0 | No |
| T005       | Modify item/group card rendering for picker mode | WP01 | P0 | No |
| T006       | Add loading/error state rendering | WP01 | P0 | Yes |
| T007       | Add useItemsManager + adapter in SpaceDetailContent | WP02 | P0 | Yes |
| T008       | Build tab bar in SpaceDetailContent | WP02 | P0 | Yes |
| T009       | Replace SharedItemPicker with SharedItemsList picker mode | WP02 | P0 | No |
| T010       | Wire tab change, loading/error, remove old import | WP02 | P0 | No |
| T011       | Add useItemsManager + adapter in TransactionDetailScreen | WP03 | P0 | Yes |
| T012       | Build tab bar in TransactionDetailScreen | WP03 | P0 | Yes |
| T013       | Replace SharedItemPicker with SharedItemsList picker mode | WP03 | P0 | No |
| T014       | Delete SharedItemPicker.tsx | WP04 | P1 | Yes |
| T015       | Update barrel exports in index.ts | WP04 | P1 | Yes |
| T016       | Verify no stale imports + type re-exports | WP04 | P1 | No |
