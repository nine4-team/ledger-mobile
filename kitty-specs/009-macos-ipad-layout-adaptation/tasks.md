# Work Packages: macOS + iPad Layout Adaptation

**Inputs**: Design documents from `/kitty-specs/009-macos-ipad-layout-adaptation/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md
**Tests**: Not explicitly requested. Testing subtasks included only as validation steps within implementation WPs.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Precise file paths included.

## Path Conventions
- **iOS/macOS**: `LedgeriOS/LedgeriOS/` (current path — target rename optional)

---

## Work Package WP01: macOS Target Setup (Priority: P0)

**Goal**: Add macOS as a supported destination so the Xcode project builds for macOS.
**Independent Test**: `xcodebuild -scheme LedgeriOS -destination 'platform=macOS'` resolves dependencies and begins compilation (build errors from UIKit references expected and accepted at this stage).
**Prompt**: `tasks/WP01-macos-target-setup.md`
**Estimated Size**: ~250 lines

### Included Subtasks
- [ ] T001 Add macOS as supported destination in Xcode project settings
- [ ] T002 Create macOS App Sandbox entitlements file with network client capability
- [ ] T003 Add LSApplicationCategoryType to Info.plist for macOS
- [ ] T004 Verify all SPM dependencies (Firebase, GoogleSignIn) resolve for macOS target

### Implementation Notes
- Xcode project modification: Add `macosx` to `SUPPORTED_PLATFORMS` in build settings
- Entitlements: `com.apple.security.app-sandbox` + `com.apple.security.network.client` (required for Firebase networking in sandbox)
- No code changes in this WP — purely project configuration
- SPM packages already declare macOS support in their Package.swift

### Parallel Opportunities
- None — sequential setup tasks.

### Dependencies
- None (starting package).

### Risks & Mitigations
- SPM resolution may fail if a transitive dependency doesn't support macOS → Check `Package.resolved` after adding macOS destination.

---

## Work Package WP02: Platform Conditional Compilation (Priority: P0)

**Goal**: Wrap all UIKit-only code with platform conditionals so the project compiles and launches on macOS.
**Independent Test**: Build succeeds on both iOS and macOS. App launches on macOS and reaches auth screen.
**Prompt**: `tasks/WP02-platform-conditionals.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T005 Wrap UIKit imports/usage in `AuthManager.swift` with `#if canImport(UIKit)` / `#if canImport(AppKit)`
- [ ] T006 Create `Platform/PlatformPresenting.swift` for cross-platform GoogleSignIn presentation
- [ ] T007 [P] Wrap `UIApplicationDelegateAdaptor` in `LedgerApp.swift` with `#if canImport(UIKit)`
- [ ] T008 [P] Wrap UIScreen/UIApplication usage in `ReportPDFSharing.swift` with `#if canImport(UIKit)`
- [ ] T009 [P] Add `contentMaxWidth`, `formMaxWidth`, `cardMinWidth` constants to `Dimensions.swift`
- [ ] T010 Build and launch on macOS — verify app reaches auth screen without crashes

### Implementation Notes
- AuthManager.swift is the only file importing UIKit directly (for GoogleSignIn's `UIViewController` presentation)
- `PlatformPresenting.swift` abstracts the sign-in presentation: `UIViewController` on iOS, `NSWindow` on macOS
- ReportPDFSharing.swift uses `UIScreen.main.scale` — wrap with `#if canImport(UIKit)` with `NSScreen` fallback
- LedgerApp.swift uses `@UIApplicationDelegateAdaptor` — wrap with `#if canImport(UIKit)`, use `@NSApplicationDelegateAdaptor` on macOS if needed
- Dimensions.swift additions are pure constants, no platform branching needed

### Parallel Opportunities
- T005/T006 (AuthManager + PlatformPresenting) are coupled.
- T007, T008, T009 are independent of each other and of T005/T006.

### Dependencies
- Depends on WP01 (macOS target must exist for compilation testing).

### Risks & Mitigations
- GoogleSignIn macOS API may differ from iOS → Research confirmed `GIDSignIn.sharedInstance.signIn(withPresenting:)` accepts `NSWindow` on macOS.
- Missing `#if` guard causes build failure on one platform → Build both targets after each change.

---

## Work Package WP03: Adaptive Navigation — Tab/Sidebar (Priority: P0)

**Goal**: Refactor MainTabView to use iOS 18+ Tab syntax with `.tabViewStyle(.sidebarAdaptable)` for automatic sidebar on Mac/iPad and tabs on iPhone.
**Independent Test**: iPhone shows bottom tab bar. iPad shows adaptable tab bar (user-toggleable sidebar). macOS shows permanent sidebar. All 4 sections navigable on all platforms.
**Prompt**: `tasks/WP03-adaptive-navigation.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T011 Create `AppSection` enum (projects, inventory, search, settings) for type-safe tab selection
- [ ] T012 Refactor MainTabView from `TabView` + `.tabItem` to iOS 18+ `Tab` syntax
- [ ] T013 Apply `.tabViewStyle(.sidebarAdaptable)` to MainTabView's TabView
- [ ] T014 Update `@SceneStorage("selectedTab")` from `Int` to `AppSection` type
- [ ] T015 Verify each tab's `NavigationStack` works independently in sidebar mode
- [ ] T016 Verify iPhone tab behavior is identical to pre-refactor (no regressions)

### Implementation Notes
- Per Axiom `axiom-swiftui-nav` Pattern 5: Each `Tab` wraps its own `NavigationStack`
- `.tabViewStyle(.sidebarAdaptable)` is iOS 18+ only — matches our iOS 18+ deployment target
- `AppSection` must conform to `String, CaseIterable` for `@SceneStorage` compatibility
- Existing `.navigationDestination(for:)` modifiers inside each tab remain unchanged
- The `.tint(BrandColors.primary)` on TabView may need adjustment for sidebar mode

### Parallel Opportunities
- None — T011 → T012 → T013 → T014 are sequential (each builds on previous).
- T015 and T016 are independent verification steps.

### Dependencies
- Depends on WP02 (macOS must build before navigation can be tested cross-platform).

### Risks & Mitigations
- `.sidebarAdaptable` may render sidebar sections differently than expected → Research confirms behavior matches Pattern 5 from Axiom nav skill.
- `@SceneStorage` with custom enum may need `RawRepresentable` conformance → Use `String` raw value.

---

## Work Package WP04: macOS Window Management & Toolbar (Priority: P1)

**Goal**: Configure macOS window behavior (size, toolbar) and add account selector toolbar item.
**Independent Test**: macOS app opens at 1000x700, enforces 800x600 minimum, shows unified toolbar with account name. Multi-window works (Cmd+N opens new window with independent navigation).
**Prompt**: `tasks/WP04-window-management.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T017 Add `.defaultSize(width: 1000, height: 700)` and `.windowResizability(.contentMinSize)` to WindowGroup scene
- [ ] T018 Add `.frame(minWidth: 800, minHeight: 600)` to RootView (macOS only via `#if os(macOS)`)
- [ ] T019 Add `.windowToolbarStyle(.unified)` to WindowGroup scene
- [ ] T020 [P] Create `AccountToolbarMenu` component for macOS toolbar account switching
- [ ] T021 Add `#if os(macOS)` toolbar item in MainTabView or RootView for `AccountToolbarMenu`
- [ ] T022 Verify multi-window behavior: independent navigation state, shared data updates

### Implementation Notes
- Window modifiers (`.defaultSize`, `.windowResizability`, `.windowToolbarStyle`) are silently ignored on iOS — safe to include unconditionally
- `.frame(minWidth:minHeight:)` should be conditional to avoid constraining iOS layout
- `AccountToolbarMenu` reads from existing `AccountContext` environment object — no new state management
- Multi-window works automatically via `WindowGroup` — each window gets independent `@State`, shared `@Observable` via environment
- `AccountToolbarMenu` uses `Menu` with `ForEach` over `accountContext.discoveredAccounts`

### Parallel Opportunities
- T020 (component creation) can proceed in parallel with T017-T019 (window configuration).

### Dependencies
- Depends on WP03 (sidebar navigation must be in place for toolbar context).

### Risks & Mitigations
- Multi-window may surface unexpected SwiftUI lifecycle issues → Test with 2+ windows, verify Firestore listeners propagate.

---

## Work Package WP05: Keyboard Shortcuts & Menu Bar (Priority: P1)

**Goal**: Add macOS menu bar with keyboard shortcuts for common actions (Cmd+N, Cmd+F, Cmd+,).
**Independent Test**: On macOS, Cmd+N opens context-appropriate creation sheet. Cmd+F focuses search. Cmd+, navigates to Settings. Menu bar shows File, Edit, View menus.
**Prompt**: `tasks/WP05-keyboard-shortcuts.md`
**Estimated Size**: ~300 lines

### Included Subtasks
- [ ] T023 Define `Notification.Name` extensions for keyboard shortcut notifications (createProject, createTransaction, createItem, createSpace, focusSearch)
- [ ] T024 Create `LedgerCommands` struct implementing `Commands` protocol with Cmd+N, Cmd+Shift+N, Cmd+F, Cmd+, shortcuts
- [ ] T025 Add `.commands { LedgerCommands() }` to WindowGroup in `LedgerApp.swift`
- [ ] T026 Wire context-sensitive Cmd+N in list views: `ProjectsListView`, `ItemsTabView`, `TransactionsTabView`, `SpacesTabView` observe notification and trigger creation sheet
- [ ] T027 Wire Cmd+F to focus search field in `UniversalSearchView` via `@FocusState`

### Implementation Notes
- Per plan.md: Menu bar commands post `NotificationCenter` notifications. Active list views observe and trigger appropriate creation sheets.
- `.commands {}` is silently ignored on iOS — safe to include unconditionally
- Context-sensitive Cmd+N: whichever list view is currently active responds to the notification
- Standard system shortcuts (Cmd+C/V/X, Cmd+Z, Cmd+W, Cmd+Q) work automatically — no custom code needed
- Cmd+, should select the Settings tab in the sidebar (update `selectedTab` binding)

### Parallel Opportunities
- T026 targets multiple files and can be split among engineers.
- T027 is independent of T023-T026.

### Dependencies
- Depends on WP03 (navigation must be refactored for context-sensitive creation to target correct views).

### Risks & Mitigations
- Multiple windows may both observe the same notification → Only the key window's active view should respond. Use `@Environment(\.controlActiveState)` to filter on macOS.

---

## Work Package WP06: Adaptive Layouts — List Views & Auth Screens (Priority: P1)

**Goal**: Apply maxWidth content constraints to all list views and auth/account screens so they don't stretch on wide screens.
**Independent Test**: On a 1440px+ macOS window, all list views show cards centered with readable widths. Auth screens are centered and constrained.
**Prompt**: `tasks/WP06-adaptive-layouts-lists.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T028 Create `AdaptiveContentWidth` wrapper component in `Components/AdaptiveContentWidth.swift`
- [ ] T029 [P] Apply `AdaptiveContentWidth` to `ProjectsListView`
- [ ] T030 [P] Apply `AdaptiveContentWidth` to `InventoryView` and sub-tabs (`InventoryItemsSubTab`, `InventorySpacesSubTab`, `InventoryTransactionsSubTab`)
- [ ] T031 [P] Apply `AdaptiveContentWidth` to `UniversalSearchView`
- [ ] T032 [P] Apply `AdaptiveContentWidth` to `SettingsView`
- [ ] T033 [P] Apply `AdaptiveContentWidth` to `AccountGateView` layout
- [ ] T034 [P] Apply `AdaptiveContentWidth` to `AuthView` / `SignInView` / `SignUpView`

### Implementation Notes
- `AdaptiveContentWidth` is a thin wrapper: `content.frame(maxWidth: maxWidth).frame(maxWidth: .infinity)` — centers content within available space
- Default `maxWidth` uses `Dimensions.contentMaxWidth` (720pt from data-model.md)
- Per Axiom `axiom-swiftui-layout`: Respond to container size, not device identity. No `UIDevice.idiom` checks.
- Apply at the scroll view / list level, not on individual cards — cards should fill the constrained container
- On iPhone, `maxWidth: 720` has no effect since screen width is always < 720pt

### Parallel Opportunities
- T029-T034 are all parallel-safe (different files, same pattern).

### Dependencies
- Depends on WP02 (needs `Dimensions.contentMaxWidth` constant from T009).

### Risks & Mitigations
- Constraining width may break existing `.frame(maxWidth: .infinity)` expectations → Test on iPhone SE (smallest) to verify no layout regressions.

---

## Work Package WP07: Adaptive Layouts — Detail Views, Forms & Grids (Priority: P1)

**Goal**: Apply readable content widths to all detail views, constrain form sheet widths on macOS, and add responsive grid columns to budget/category views.
**Independent Test**: Detail views show centered content on wide screens. Budget category cards use multi-column grid on wide screens. Form sheets have fixed width on macOS.
**Prompt**: `tasks/WP07-adaptive-layouts-details.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T035 [P] Apply maxWidth to `ProjectDetailView` content sections
- [ ] T036 [P] Apply maxWidth to `ItemDetailView` content sections
- [ ] T037 [P] Apply maxWidth to `TransactionDetailView` content sections
- [ ] T038 [P] Apply maxWidth to `SpaceDetailView` content sections
- [ ] T039 Add responsive grid columns to `BudgetTabView` via `onGeometryChange`
- [ ] T040 Add responsive grid columns to `AccountingTabView` via `onGeometryChange`
- [ ] T041 Constrain `FormSheet` width on macOS using `Dimensions.formMaxWidth`

### Implementation Notes
- Detail views: Wrap content in `AdaptiveContentWidth` (from WP06) or use `.frame(maxWidth: Dimensions.contentMaxWidth)` directly
- Responsive grids per Axiom `axiom-swiftui-layout` Pattern 3: `onGeometryChange(for: Int.self)` calculates `max(1, Int(proxy.size.width / Dimensions.cardMinWidth))` for column count
- Use `LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: columnCount))` for dynamic grid
- `FormSheet` width: On macOS, sheets present as window-attached panels. Apply `.frame(maxWidth: Dimensions.formMaxWidth)` to sheet content for consistent width.
- `.presentationDetents()` silently ignored on macOS — no changes needed to existing detent code

### Parallel Opportunities
- T035-T038 are all parallel-safe (different detail views).
- T039-T040 are independent (different tab views).

### Dependencies
- Depends on WP06 (`AdaptiveContentWidth` component created in T028).

### Risks & Mitigations
- Detail views with many sections may need per-section width constraints rather than one wrapper → Test with long content.
- `onGeometryChange` column recalculation may cause layout flicker during window resize → Add `.animation(.default, value: columnCount)`.

---

## Work Package WP08: Cross-Platform Testing & Polish (Priority: P2)

**Goal**: Verify all 7 spec scenarios pass. No regressions on iPhone. All platforms work correctly.
**Independent Test**: All spec acceptance criteria met. All existing iPhone screens render correctly.
**Prompt**: `tasks/WP08-testing-polish.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T042 Test Scenario 1: First Launch on Mac — sign in, sidebar, projects load
- [ ] T043 Test Scenario 2: Multi-Window Workflow — two windows, independent navigation, shared data
- [ ] T044 Test Scenario 3: iPad Landscape/Portrait Transition — sidebar ↔ tabs, section preserved
- [ ] T045 Test Scenario 4: Keyboard-Driven Project Creation — Cmd+N, form keyboard navigation
- [ ] T046 Test Scenario 5: Account Switching via Mac Toolbar — dropdown, context refresh
- [ ] T047 Test Scenario 6: Wide Screen Card Layout — cards readable at 2560px, no stretching
- [ ] T048 Test Scenario 7: iPhone Experience Unchanged — iPhone SE, iPhone 15 Pro Max, no regressions

### Implementation Notes
- Run each scenario manually on the appropriate platform/device
- For Scenario 3 (iPad rotation): Test in iPad simulator with Cmd+Left/Right to rotate
- For Scenario 7 (iPhone): Build and run on iPhone SE and iPhone 15 Pro Max simulators
- Fix any issues discovered during testing before marking this WP complete
- Document any platform-specific behaviors that differ from spec expectations

### Parallel Opportunities
- T042-T048 can all be tested in parallel on different simulators/devices.

### Dependencies
- Depends on WP03, WP04, WP05, WP06, WP07 (all feature WPs must be complete).

### Risks & Mitigations
- iPad orientation transition may not preserve exact selection state → Test thoroughly, file bugs if SwiftUI framework has limitations.
- Sheet presentation may look unexpected on macOS → Accepted per research.md — sheets are window-attached on macOS.

---

## Dependency & Execution Summary

```
WP01 (Target Setup)
  └─▶ WP02 (Platform Conditionals)
       ├─▶ WP03 (Adaptive Navigation)
       │    ├─▶ WP04 (Window & Toolbar)  ←── can parallel with WP05
       │    └─▶ WP05 (Keyboard Shortcuts) ←── can parallel with WP04
       └─▶ WP06 (Adaptive Layouts — Lists)  ←── can parallel with WP03
            └─▶ WP07 (Adaptive Layouts — Details)
                 └─▶ WP08 (Testing & Polish) ←── also depends on WP04, WP05
```

- **Sequence**: WP01 → WP02 → { WP03 || WP06 } → { WP04 || WP05 || WP07 } → WP08
- **Parallelization**: After WP02 completes, WP03 and WP06 can run in parallel. After WP03, WP04 and WP05 can run in parallel. WP07 runs after WP06.
- **MVP Scope**: WP01 + WP02 + WP03 = macOS builds, launches, and shows sidebar navigation. This is the minimum viable cross-platform experience.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add macOS destination in Xcode | WP01 | P0 | No |
| T002 | Create macOS App Sandbox entitlements | WP01 | P0 | No |
| T003 | Add LSApplicationCategoryType to Info.plist | WP01 | P0 | No |
| T004 | Verify SPM dependencies for macOS | WP01 | P0 | No |
| T005 | Wrap UIKit in AuthManager.swift | WP02 | P0 | No |
| T006 | Create PlatformPresenting.swift | WP02 | P0 | No |
| T007 | Wrap UIApplicationDelegateAdaptor in LedgerApp.swift | WP02 | P0 | Yes |
| T008 | Wrap UIScreen in ReportPDFSharing.swift | WP02 | P0 | Yes |
| T009 | Add layout constants to Dimensions.swift | WP02 | P0 | Yes |
| T010 | Build and launch on macOS | WP02 | P0 | No |
| T011 | Create AppSection enum | WP03 | P0 | No |
| T012 | Refactor MainTabView to Tab syntax | WP03 | P0 | No |
| T013 | Apply .tabViewStyle(.sidebarAdaptable) | WP03 | P0 | No |
| T014 | Update @SceneStorage to AppSection type | WP03 | P0 | No |
| T015 | Verify NavigationStack in sidebar mode | WP03 | P0 | No |
| T016 | Verify iPhone tabs unchanged | WP03 | P0 | No |
| T017 | Add window size/resizability modifiers | WP04 | P1 | No |
| T018 | Add minWidth/minHeight frame to RootView | WP04 | P1 | No |
| T019 | Add windowToolbarStyle(.unified) | WP04 | P1 | No |
| T020 | Create AccountToolbarMenu component | WP04 | P1 | Yes |
| T021 | Add toolbar item for account selector | WP04 | P1 | No |
| T022 | Verify multi-window behavior | WP04 | P1 | No |
| T023 | Define Notification.Name extensions | WP05 | P1 | No |
| T024 | Create LedgerCommands struct | WP05 | P1 | No |
| T025 | Add .commands to LedgerApp | WP05 | P1 | No |
| T026 | Wire Cmd+N in list views | WP05 | P1 | Yes |
| T027 | Wire Cmd+F to focus search | WP05 | P1 | Yes |
| T028 | Create AdaptiveContentWidth component | WP06 | P1 | No |
| T029 | Apply to ProjectsListView | WP06 | P1 | Yes |
| T030 | Apply to InventoryView + sub-tabs | WP06 | P1 | Yes |
| T031 | Apply to UniversalSearchView | WP06 | P1 | Yes |
| T032 | Apply to SettingsView | WP06 | P1 | Yes |
| T033 | Apply to AccountGateView | WP06 | P1 | Yes |
| T034 | Apply to AuthView / SignIn / SignUp | WP06 | P1 | Yes |
| T035 | Apply maxWidth to ProjectDetailView | WP07 | P1 | Yes |
| T036 | Apply maxWidth to ItemDetailView | WP07 | P1 | Yes |
| T037 | Apply maxWidth to TransactionDetailView | WP07 | P1 | Yes |
| T038 | Apply maxWidth to SpaceDetailView | WP07 | P1 | Yes |
| T039 | Responsive grid in BudgetTabView | WP07 | P1 | Yes |
| T040 | Responsive grid in AccountingTabView | WP07 | P1 | Yes |
| T041 | Constrain FormSheet width on macOS | WP07 | P1 | Yes |
| T042 | Test Scenario 1: First Launch on Mac | WP08 | P2 | Yes |
| T043 | Test Scenario 2: Multi-Window Workflow | WP08 | P2 | Yes |
| T044 | Test Scenario 3: iPad Orientation | WP08 | P2 | Yes |
| T045 | Test Scenario 4: Keyboard-Driven Creation | WP08 | P2 | Yes |
| T046 | Test Scenario 5: Account Switching | WP08 | P2 | Yes |
| T047 | Test Scenario 6: Wide Screen Layout | WP08 | P2 | Yes |
| T048 | Test Scenario 7: iPhone Unchanged | WP08 | P2 | Yes |
