---
description: "Work package task list for Architecture Critique Implementation"
---

# Work Packages: Architecture Critique Implementation

**Inputs**: Design documents from `/kitty-specs/001-architecture-critique-implementation/`
**Prerequisites**: spec.md (user stories), implementation plan in `.plans/architecture-critique-implementation-plan.md`

**Context**: Phase 1 (foundation infrastructure) is complete. This work implements Phases 2-5 to address findings from the architecture critique.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Simple Edit Screens Migration (Priority: P1) ðŸŽ¯ MVP

**Goal**: Migrate the 3 simplest edit screens (project, 2 spaces) to use `useEditForm` hook with partial writes.
**Independent Test**: Open each screen, change one field, save - verify only that field is in the update payload. Save with no changes - verify no write occurs.
**Estimated Prompt Size**: ~450 lines
**Prompt**: `/tasks/WP01-simple-edit-screens-migration.md`

### Included Subtasks
- [x] T001 Migrate project edit screen (`app/project/[projectId]/edit.tsx`) - 3 basic fields (name, clientName, description)
- [x] T002 [P] Migrate business inventory space edit (`app/business-inventory/spaces/[spaceId]/edit.tsx`) - 2 fields (name, notes)
- [x] T003 [P] Migrate project space edit (`app/project/[projectId]/spaces/[spaceId]/edit.tsx`) - 2 fields (name, notes)
- [x] T004 Verify TypeScript compilation passes with no new errors
- [x] T005 Manual verification: test each screen with single-field changes and no-change saves

### Implementation Notes
- Project edit already has partial writes; migrate basic fields to `useEditForm` for consistency
- Budget handling in project edit stays separate (not migrating)
- Space edits: Add change detection in `handleSubmit`, compare against `initialValues`, only send changed fields to `updateSpace()`
- No changes to `SpaceForm` component itself
- All screens: Add `shouldAcceptSubscriptionData` protection to prevent subscription overwrites during editing

### Parallel Opportunities
- T002 and T003 can proceed in parallel (different files, no shared dependencies)

### Dependencies
- Depends on Phase 1 completion (useEditForm hook exists)

### Risks & Mitigations
- Risk: Breaking existing project edit partial write logic
  - Mitigation: Only migrate basic fields, leave budget handling untouched
- Risk: Space form behavior changes
  - Mitigation: Keep SpaceForm component unchanged, add detection only in screen handlers

---

## Work Package WP02: Settings Budget Category Edit (Priority: P1)

**Goal**: Add change tracking to budget category edit in settings modal.
**Independent Test**: Open settings, edit a budget category, change one field, save - verify only that field is updated.
**Estimated Prompt Size**: ~350 lines
**Prompt**: `/tasks/WP02-settings-budget-category-edit.md`

### Included Subtasks
- [x] T006 Add inline comparison in `handleSaveCategoryDetails` (`app/(tabs)/settings.tsx`) for 3 fields (name, slug, metadata)
- [x] T007 Implement change detection logic - compare against existing category
- [x] T008 Update save handler to skip write if no changes detected
- [x] T009 Verify TypeScript compilation passes
- [x] T010 Manual verification: test single-field edits and no-change saves

### Implementation Notes
- No hook needed - this is a modal form with simple fields
- Inline comparison in `handleSaveCategoryDetails` against the existing category
- Skip write entirely if `hasChanges` is false

### Parallel Opportunities
- None - single file modification

### Dependencies
- None (independent of other work packages)

### Risks & Mitigations
- Risk: Modal save behavior change
  - Mitigation: Keep existing validation, only add change detection before update call

---

## Work Package WP03: Item Edit Screen Migration (Priority: P1)

**Goal**: Migrate item edit screen (9 fields) to use `useEditForm` with proper change tracking.
**Independent Test**: Open item edit, change name only, save - verify only name in payload. Price changes - verify cents values tracked correctly.
**Estimated Prompt Size**: ~550 lines
**Prompt**: `/tasks/WP03-item-edit-screen-migration.md`

### Included Subtasks
- [x] T011 Replace 9 `useState` calls with `useEditForm<ItemFormValues>` in `app/items/[id]/edit.tsx`
- [x] T012 Implement price field handling - hook tracks cents values, display strings convert via `setField`
- [x] T013 Add `shouldAcceptSubscriptionData` protection for subscription updates
- [x] T014 Update save handler to use `getChangedFields()` and skip write if no changes
- [x] T015 Verify TypeScript compilation passes
- [x] T016 Manual verification: test single-field edits, price changes, no-change saves, subscription protection

### Implementation Notes
- 9 fields total: name, description, spaceId, status, 3 price fields (estimatedPrice, purchasePrice, salePrice), quantity, tags
- Price fields: hook tracks cents values (data-model types); separate display strings for three price inputs convert on change via `setField`
- `shouldAcceptSubscriptionData` prevents form overwrites after user edits
- If `hasChanges` is false on save, skip the write and just navigate

### Parallel Opportunities
- None - single complex file migration

### Dependencies
- Depends on Phase 1 completion (useEditForm hook exists)

### Risks & Mitigations
- Risk: Price conversion logic errors
  - Mitigation: Test all three price fields independently, verify cents values in payload
- Risk: Form state synchronization issues
  - Mitigation: Thorough testing of subscription protection with `shouldAcceptSubscriptionData`

---

## Work Package WP04: Transaction Edit Screen Migration (Priority: P1)

**Goal**: Migrate transaction edit screen (13 fields, most complex) to use `useEditForm` with change tracking and special handling for computed fields.
**Independent Test**: Open transaction edit, change budgetCategoryId only, save - verify only that field in payload and linked items update. Change amount - verify tax/subtotal computed correctly.
**Estimated Prompt Size**: ~650 lines
**Prompt**: `/tasks/WP04-transaction-edit-screen-migration.md`

### Included Subtasks
- [ ] T017 Replace 13 `useState` calls with `useEditForm<TransactionFormValues>` in `app/transactions/[id]/edit.tsx`
- [ ] T018 Implement tax/subtotal computation in save handler - computed values go through `getChangedFields()`
- [ ] T019 Add `budgetCategoryId` change propagation to linked items (preserve lines 248-252 logic)
- [ ] T020 Add `shouldAcceptSubscriptionData` protection for subscription updates
- [ ] T021 Update save handler to use `getChangedFields()` and skip write if no changes
- [ ] T022 Verify TypeScript compilation passes
- [ ] T023 Manual verification: test single-field edits, budgetCategoryId propagation, computed fields, no-change saves, subscription protection

### Implementation Notes
- 13 fields: date, description, amount, budgetCategoryId, accountId, payee, notes, tax, subtotal, attachments, tags, status, type
- Tax/subtotal computation stays in save handler - computed values go through `getChangedFields()`
- `budgetCategoryId` change propagation to linked items (lines 248-252) still fires if that field is in the changed set
- Most complex migration due to field count and special logic
- `shouldAcceptSubscriptionData` prevents form overwrites after user edits
- If `hasChanges` is false on save, skip the write and just navigate

### Parallel Opportunities
- None - single complex file migration with interdependent logic

### Dependencies
- Depends on Phase 1 completion (useEditForm hook exists)

### Risks & Mitigations
- Risk: Computed field calculation errors
  - Mitigation: Verify tax/subtotal calculations match existing behavior exactly
- Risk: Linked item propagation breaks
  - Mitigation: Preserve exact logic from lines 248-252, only gate on field presence in changed set
- Risk: Form state complexity
  - Mitigation: Thorough testing with all 13 fields, computed values, and propagation logic

---

## Work Package WP05: Defensive Rendering & Sync Errors (Priority: P2)

**Goal**: Implement defensive rendering for missing space references and improve sync error visibility.
**Independent Test**: Archive a space, view item detail - verify "Unknown space" displayed. Trigger sync failure - verify specific error message shown.
**Estimated Prompt Size**: ~400 lines
**Prompt**: `/tasks/WP05-defensive-rendering-sync-errors.md`

### Included Subtasks
- [ ] T024 [P] Update item detail space label fallback in `app/items/[id]/index.tsx` (line 298: change from `item.spaceId` to `'Unknown space'`)
- [ ] T025 [P] Verify `resolveSpaceName` in `src/data/reportDataService.ts` handles missing spaces gracefully (returns null)
- [ ] T026 [P] Update `SyncStatusBanner` in `src/components/SyncStatusBanner.tsx` to show specific error messages
- [ ] T027 [P] Implement logic: single failure shows specific error, multiple failures show count
- [ ] T028 [P] Use `getTrackedRequestsSnapshot()` from `src/sync/requestDocTracker.ts` to read error messages
- [ ] T029 Verify TypeScript compilation passes
- [ ] T030 Manual verification: archive space test, sync failure test

### Implementation Notes
- **Phase 3 (Defensive Rendering)**:
  - Item detail: Simple string replacement in fallback
  - Report service: Verify existing behavior (no code change needed if already returns null)
- **Phase 4 (Sync Errors)**:
  - Read error messages from `getTrackedRequestsSnapshot()` (already exported)
  - If `failedRequestDocs === 1`: show the specific `errorMessage`
  - If `failedRequestDocs > 1`: show "N operations failed. Tap Retry or Dismiss."
- Small changes, uses existing infrastructure

### Parallel Opportunities
- All subtasks can proceed in parallel (different files/concerns)

### Dependencies
- None (independent of edit screen work)

### Risks & Mitigations
- Risk: Breaking existing sync banner functionality
  - Mitigation: Only add error detail display, preserve existing retry/dismiss logic
- Risk: Report service change breaks queries
  - Mitigation: Only verify/document existing behavior, make no changes if already correct

---

## Work Package WP06: Architecture Documentation Updates (Priority: P3)

**Goal**: Update architecture documentation to reflect implemented patterns and design decisions.
**Independent Test**: Review updated ARCHITECTURE.md - verify all 4 findings (F2, F3, F9, F10) are addressed with clear explanations.
**Estimated Prompt Size**: ~500 lines
**Prompt**: `/tasks/WP06-architecture-documentation-updates.md`

### Included Subtasks
- [ ] T031 Rewrite "high-risk fields" justification (Finding 3) - replace probability argument with data model argument
- [ ] T032 Add "Known Limitations" section (Finding 2) - document silent security rule failures
- [ ] T033 Add schema evolution stance (Finding 9) - document pattern for optional fields
- [ ] T034 Update "Do NOT Build" list (Finding 10) - add full-form overwrite guidance
- [ ] T035 Add distinction between lightweight staleness check vs full compare-before-commit UX
- [ ] T036 Verify all sections flow logically and provide clear guidance for future developers

### Implementation Notes
- Modify: `docs/specs/ARCHITECTURE.md` (moved from `.cursor/plans/firebase-mobile-migration/10_architecture/`)
- **Finding 3 (high-risk fields)**: Replace "concurrent edits are rare" with data model argument:
  - `budgetCents`, `purchasePriceCents`, etc. are source/planning data, not derived totals
  - Each is direct user input on single document - correct value is what they last entered
  - Actual spend totals computed at read time from transactions via `buildBudgetProgress()` - never stored as competing field
  - Fallback: `updatedAt` security rule checks if needed (one-line rule, no Cloud Function)
- **Finding 2 (silent failures)**: Document that Firestore applies writes optimistically to local cache even if server rejects them. User may see "phantom" values that never sync. Accepted for MVP.
- **Finding 9 (schema evolution)**: Document pattern: new optional fields + `merge: true` + `undefined` handling in reads. No formal migration framework for MVP. If breaking changes needed: `schemaVersion` field + read-time normalizer.
- **Finding 10 (Do NOT Build)**: Add: "Full-form overwrites on edit screens - always use `getChangedFields()` to send only modified fields." Update: Distinguish "lightweight staleness check" from "full compare-before-commit UX" - the former is cheap and is what `useEditForm` provides.

### Parallel Opportunities
- All documentation subtasks can proceed in parallel (same file but independent sections)

### Dependencies
- Should be done AFTER WP01-WP04 complete (documentation reflects actual implemented patterns)

### Risks & Mitigations
- Risk: Documentation inconsistent with implementation
  - Mitigation: Review against actual code from WP01-WP04 before finalizing
- Risk: Unclear guidance for future developers
  - Mitigation: Include specific examples and anti-patterns from the implementation work

---

## Dependency & Execution Summary

**Execution Sequence**:
1. **Phase 2A (WP01-WP04)**: Edit screen migrations - can proceed in order of complexity (simplest to most complex)
   - WP01 (simple screens) â†’ WP02 (settings) â†’ WP03 (items) â†’ WP04 (transactions)
   - Or: Start all in parallel if multiple engineers available
2. **Phase 3 & 4 (WP05)**: Defensive rendering and sync errors - can run in parallel with Phase 2
3. **Phase 5 (WP06)**: Documentation updates - should run AFTER WP01-WP04 complete

**Parallelization Options**:
- **Maximum parallelization**: All WPs can technically start simultaneously (Phase 2 screens are independent, Phase 3/4 are independent)
- **Recommended phasing**:
  - Start WP01-WP04 together (or in sequence by complexity)
  - Start WP05 anytime (no dependencies)
  - Start WP06 after WP01-WP04 complete (docs should reflect actual code)

**MVP Scope**: WP01 (simple screens) delivers immediate value and establishes pattern for remaining screens.

**Critical Path**: WP01 â†’ WP02 â†’ WP03 â†’ WP04 â†’ WP06 (sequential if single engineer)

**Verification Strategy**:
- Each WP includes verification subtasks
- Final verification: All 6 edit screens use consistent patterns (SC-009)
- TypeScript compilation passes with no new errors (SC-010)
- Run full test suite from `.plans/architecture-critique-implementation-plan.md` verification sections

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Migrate project edit screen (3 fields) | WP01 | P1 | No |
| T002 | Migrate business inventory space edit (2 fields) | WP01 | P1 | Yes |
| T003 | Migrate project space edit (2 fields) | WP01 | P1 | Yes |
| T004 | Verify TypeScript compilation (WP01) | WP01 | P1 | No |
| T005 | Manual verification (WP01) | WP01 | P1 | No |
| T006 | Add inline comparison in settings | WP02 | P1 | No |
| T007 | Implement change detection logic | WP02 | P1 | No |
| T008 | Update save handler (skip if no changes) | WP02 | P1 | No |
| T009 | Verify TypeScript compilation (WP02) | WP02 | P1 | No |
| T010 | Manual verification (WP02) | WP02 | P1 | No |
| T011 | Replace useState with useEditForm (items) | WP03 | P1 | No |
| T012 | Implement price field handling | WP03 | P1 | No |
| T013 | Add subscription protection | WP03 | P1 | No |
| T014 | Update save handler with getChangedFields | WP03 | P1 | No |
| T015 | Verify TypeScript compilation (WP03) | WP03 | P1 | No |
| T016 | Manual verification (WP03) | WP03 | P1 | No |
| T017 | Replace useState with useEditForm (transactions) | WP04 | P1 | No |
| T018 | Implement tax/subtotal computation | WP04 | P1 | No |
| T019 | Add budgetCategoryId propagation | WP04 | P1 | No |
| T020 | Add subscription protection | WP04 | P1 | No |
| T021 | Update save handler with getChangedFields | WP04 | P1 | No |
| T022 | Verify TypeScript compilation (WP04) | WP04 | P1 | No |
| T023 | Manual verification (WP04) | WP04 | P1 | No |
| T024 | Update item detail space label fallback | WP05 | P2 | Yes |
| T025 | Verify resolveSpaceName handles missing spaces | WP05 | P2 | Yes |
| T026 | Update SyncStatusBanner for specific errors | WP05 | P2 | Yes |
| T027 | Implement error display logic | WP05 | P2 | Yes |
| T028 | Use getTrackedRequestsSnapshot | WP05 | P2 | Yes |
| T029 | Verify TypeScript compilation (WP05) | WP05 | P2 | No |
| T030 | Manual verification (WP05) | WP05 | P2 | No |
| T031 | Rewrite high-risk fields justification | WP06 | P3 | Yes |
| T032 | Add Known Limitations section | WP06 | P3 | Yes |
| T033 | Add schema evolution stance | WP06 | P3 | Yes |
| T034 | Update Do NOT Build list | WP06 | P3 | Yes |
| T035 | Add staleness check distinction | WP06 | P3 | Yes |
| T036 | Verify documentation flows logically | WP06 | P3 | No |

**Total Subtasks**: 36
**Work Packages**: 6
**Average Subtasks per WP**: 6.0
**Estimated Prompt Size Range**: 350-650 lines per WP

---

> All work packages are sized for single-session implementation (3-7 subtasks, 350-650 line prompts). Phase 1 foundation work is complete. This task breakdown implements Phases 2-5 of the architecture critique remediation plan.
