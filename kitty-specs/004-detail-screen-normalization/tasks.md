# Work Packages: Detail Screen Normalization

**Inputs**: Design documents from `kitty-specs/004-detail-screen-normalization/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: No automated tests required (manual testing only).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Precise file paths included for each subtask.

---

## Phase 1: Space Consolidation + SectionList Migration (P1)

### Work Package WP01: Consolidate Space Detail Screens (Priority: P1) ðŸŽ¯ MVP

**Goal**: Eliminate the ~1,000 lines of duplication between the two near-identical space detail screens by extracting a shared `SpaceDetailContent` component. Normalize space media to use `MediaGallerySection`.
**Independent Test**: Navigate to a space from both business inventory and from a project. Both render identically with the same sections, media gallery, items, and checklists. Edit a space name, add/remove images, manage items â€” all work in both contexts.
**Prompt**: `tasks/WP01-consolidate-space-detail.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [x] T001 Create `src/components/SpaceDetailContent.tsx` skeleton with `SpaceScope` type and all imports
- [x] T002 Extract shared state, hooks, and handlers from BI space detail reference
- [x] T003 Parameterize navigation routes, scope config, picker labels, and scope-dependent handler logic
- [x] T004 Replace space media (ThumbnailGrid/ImageGallery/ImagePickerButton) with `MediaGallerySection`
- [x] T005 Reduce both route files to thin wrappers (~20 lines each)
- [x] T006 Normalize styles and clean up accidental divergence between the two files

### Implementation Notes
- Use BI space detail (`app/business-inventory/spaces/[spaceId].tsx`) as the reference copy
- Scope config: `scope.projectId ? createProjectScopeConfig(scope.projectId) : createInventoryScopeConfig()`
- Navigation routes parameterized via helper functions that accept `projectId | null`
- MediaGallerySection replaces ThumbnailGrid+ImageGallery+ImagePickerButton. Set `maxAttachments={100}` for spaces
- Route wrappers follow the pattern in data-model.md: extract params, guard, render `<SpaceDetailContent scope={...} />`

### Parallel Opportunities
- T001-T003 are sequential (build the component incrementally)
- T004 (media) can proceed once T001-T002 establish the component structure
- T005 (wrappers) can proceed once T003 establishes the scope API

### Dependencies
- None (starting package).

### Risks & Mitigations
- **Navigation breaks**: Both route files remain in place â€” only content moves to shared component
- **Media handler signature mismatch**: MediaGallerySection handlers accept `(localUri, kind) => void | Promise<void>`, matching existing fire-and-forget pattern

---

### Work Package WP02: Migrate Space Detail to SectionList (Priority: P1)

**Goal**: Convert SpaceDetailContent from AppScrollView to SectionList with collapsible sections, replacing manual StickyHeader with native sticky behavior.
**Independent Test**: On space detail, sections (Images, Notes, Items, Checklists) can be collapsed/expanded via CollapsibleSectionHeader. Items control bar sticks when scrolling. StickyHeader component is no longer used.
**Prompt**: `tasks/WP02-space-sectionlist-migration.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T007 Define section structure for SpaceDetailContent (media, notes, items, checklists)
- [x] T008 Add collapsed state management with per-section defaults
- [x] T009 Replace AppScrollView + StickyHeader with SectionList
- [x] T010 Implement `renderSectionHeader` for items section (sticky control bar)
- [x] T011 Implement `renderItem` for all sections with SECTION_HEADER_MARKER pattern

### Implementation Notes
- Follow the transaction detail reference pattern: SECTION_HEADER_MARKER as first data item for non-sticky sections
- Only items section uses `renderSectionHeader` (returns non-null); all others render headers inline via renderItem
- Default collapsed states: media=false (expanded), notes=true, items=false (expanded), checklists=true
- Set `stickySectionHeadersEnabled={true}` for native sticky on items control bar

### Parallel Opportunities
- None within this WP â€” changes are sequential to the same file.

### Dependencies
- Depends on WP01 (SpaceDetailContent must exist).

### Risks & Mitigations
- **Scroll performance**: Transaction detail already validates SectionList approach; same pattern applies
- **Checklist section complexity**: Inline checklist rendering (TextInput, checkboxes) must work inside SectionList renderItem

---

### Work Package WP03: Migrate Item Detail to SectionList (Priority: P1)

**Goal**: Convert item detail screen from AppScrollView to SectionList with collapsible sections using CollapsibleSectionHeader.
**Independent Test**: On item detail, sections (Images, Notes, Details) can be collapsed/expanded. Hero section is always visible. All existing functionality preserved.
**Prompt**: `tasks/WP03-item-sectionlist-migration.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T012 [P] Define section structure for item detail (hero, media, notes, details)
- [x] T013 [P] Add collapsed state management with item-specific defaults
- [x] T014 Replace AppScrollView with SectionList
- [x] T015 Implement `renderItem` for item detail sections
- [x] T016 Preserve existing functionality (error banner, Move section, menus) and clean up

### Implementation Notes
- Hero section is non-collapsible (always visible, no header)
- No sticky sections needed â€” set `stickySectionHeadersEnabled={false}` (item detail has no items list control bar)
- Default collapsed states: media=false (expanded), notes=true, details=true
- Move Item form (scope !== 'inventory') renders as part of details section or as separate section
- BottomSheetMenuList stays at component root, outside SectionList

### Parallel Opportunities
- WP03 can run entirely in parallel with WP01 + WP02 (different file)

### Dependencies
- None (item detail is independent of space detail work).

### Risks & Mitigations
- **Low risk**: Item detail is simpler (694 lines, no items list, no bulk operations)
- **Error banner**: Must ensure conditional error card renders correctly within SectionList

---

## Phase 2: Shared Items Management (P2)

### Work Package WP04: Extract useItemsManager Hook (Priority: P2)

**Goal**: Extract the duplicated items management state and logic (search, sort, filter, selection) from transaction detail and space detail into a reusable `useItemsManager` hook.
**Independent Test**: Hook can be imported and initialized with config. Returns correct filtered/sorted items, selection state, and handlers. All types are well-defined.
**Prompt**: `tasks/WP04-use-items-manager-hook.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T017 [P] Define types and create hook skeleton in `src/hooks/useItemsManager.ts`
- [x] T018 Implement search, sort, and filter state with menu visibility
- [x] T019 Implement filtered and sorted items computation (3-step pipeline)
- [x] T020 Implement selection state and handlers (toggle, selectAll, clear)

### Implementation Notes
- Type definitions from data-model.md: `UseItemsManagerConfig`, `UseItemsManagerReturn`
- filteredAndSortedItems uses useMemo: filter â†’ search â†’ sort pipeline
- Search is case-insensitive across configurable `searchFields` (default: name, sku, source, notes)
- Selection operates on `Set<string>` for O(1) lookups
- selectAll selects only currently visible (filtered) items
- Hook is pure state management â€” no rendering, no service calls

### Parallel Opportunities
- WP04 can run entirely in parallel with WP01-WP03 (new file, no dependencies)

### Dependencies
- None (hook is standalone).

### Risks & Mitigations
- **API mismatch**: Design API from research on all 3 consumers (transaction, space, SharedItemsList). Keep escape hatches via filterFn
- **Sort mode differences**: Transaction has 6 modes + price sort; space has 4 modes. Hook accepts configurable sortModes array

---

### Work Package WP05: Create ItemsSection Component + Integration (Priority: P2)

**Goal**: Create a shared `ItemsSection` component that renders the items list with control bar, item cards, and bulk action panel. Integrate into both space detail and transaction detail.
**Independent Test**: On both space detail and transaction detail, items management works identically: search, sort, filter, bulk select, bulk actions. All use shared ItemsSection component.
**Prompt**: `tasks/WP05-items-section-component.md`
**Estimated Size**: ~500 lines

### Included Subtasks
- [ ] T021 Create `src/components/ItemsSection.tsx` skeleton with props interface
- [ ] T022 Implement items list rendering with ItemCard integration
- [ ] T023 Implement bulk action panel with screen-specific actions config
- [ ] T024 Integrate ItemsSection into SpaceDetailContent
- [ ] T025 Integrate ItemsSection into transaction detail

### Implementation Notes
- ItemsSection renders: item list (ItemCard per item), bulk panel (when hasSelection), empty state
- Control bar rendering stays in renderSectionHeader (sticky) â€” ItemsSection provides the items list content only
- Screen-specific bulk actions passed as config array of `BulkAction` objects
- Space bulk actions: move between spaces, remove from space
- Transaction bulk actions: set space, set status, set SKU, remove from transaction, delete
- onBulkAction callback receives (actionId, selectedIds[])
- Transaction-specific features to verify after integration: price sort mode, SKU bulk assign, status bulk assign, duplicate item, item conflict resolution UI

### Parallel Opportunities
- T021-T023 (create component) can proceed once WP04 is complete
- T024 and T025 can proceed in parallel (different files)

### Dependencies
- Depends on WP02 (space detail must be on SectionList)
- Depends on WP04 (useItemsManager hook must exist)

### Risks & Mitigations
- **Bulk action diversity**: Transaction has more bulk actions (space, status, SKU, remove, delete) vs space (move, remove). Config-driven approach handles this
- **Control bar placement**: Control bar must remain in SectionList's renderSectionHeader for stickiness. ItemsSection handles item list content, not the control bar header

---

## Phase 3: Detail Row Extraction (P3)

### Work Package WP06: Create DetailRow Component (Priority: P3)

**Goal**: Extract the inline detail row rendering pattern into a shared `DetailRow` component and adopt it across all screens that render key-value detail rows.
**Independent Test**: Detail rows on transaction detail and item detail use the shared `DetailRow` component with consistent visual treatment (label left, value right, divider).
**Prompt**: `tasks/WP06-detail-row-component.md`
**Estimated Size**: ~300 lines

### Included Subtasks
- [ ] T026 [P] Create `src/components/DetailRow.tsx` with `DetailRowProps` interface
- [ ] T027 [P] Adopt DetailRow in transaction detail DetailsSection
- [ ] T028 [P] Adopt DetailRow in item detail Details card
- [ ] T029 Clean up duplicate detail row styles from adopting screens
- [ ] T030 Verify MediaGallerySection integration on space detail (no image cap regressions, add/remove/set-primary work)

### Implementation Notes
- DetailRow API from data-model.md: `{ label, value, showDivider?, onPress? }`
- value accepts `string | React.ReactNode` for flexibility
- Uses existing inline pattern: label (caption, secondary), value (body, right-aligned), 1px divider
- Last row in each group sets `showDivider={false}`
- Transaction DetailsSection has ~8 rows; item detail has ~7 rows

### Parallel Opportunities
- T026 (create component), T027 (transaction adoption), T028 (item adoption), T030 (media verification) can all proceed in parallel once the component exists
- WP06 can run in parallel with WP04/WP05 (touches different code: detail rows vs items management)

### Dependencies
- None (can run any time; detail rows are independent of SectionList migration and items extraction)

### Risks & Mitigations
- **Low risk**: Simple presentational component extraction
- **Style consistency**: Use BI space detail's existing inline styles as reference (they match transaction detail)

---

## Dependency & Execution Summary

```
Phase 1 (P1):
  WP01 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º WP02 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º WP05
  WP03 (parallel)                                  â–²
  WP04 (parallel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 3 (P3):
  WP06 (parallel with WP04/WP05)
```

- **Sequence**: WP01 â†’ WP02 â†’ WP05 (space path); WP04 â†’ WP05 (hook path)
- **Parallelization**: WP01 âˆ¥ WP03 âˆ¥ WP04 âˆ¥ WP06 can all start simultaneously
- **MVP Scope**: WP01 alone delivers the biggest win (~1,000 lines eliminated). WP01 + WP02 + WP03 complete User Stories 1-2.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create SpaceDetailContent skeleton | WP01 | P1 | No |
| T002 | Extract shared state/hooks/handlers | WP01 | P1 | No |
| T003 | Parameterize navigation and scope logic | WP01 | P1 | No |
| T004 | Replace space media with MediaGallerySection | WP01 | P1 | No |
| T005 | Reduce route files to thin wrappers | WP01 | P1 | No |
| T006 | Normalize styles and clean up divergence | WP01 | P1 | No |
| T007 | Define section structure for space detail | WP02 | P1 | No |
| T008 | Add collapsed state management (space) | WP02 | P1 | No |
| T009 | Replace AppScrollView with SectionList (space) | WP02 | P1 | No |
| T010 | Implement renderSectionHeader for items (space) | WP02 | P1 | No |
| T011 | Implement renderItem for all space sections | WP02 | P1 | No |
| T012 | Define section structure for item detail | WP03 | P1 | Yes |
| T013 | Add collapsed state management (item) | WP03 | P1 | Yes |
| T014 | Replace AppScrollView with SectionList (item) | WP03 | P1 | No |
| T015 | Implement renderItem for item detail sections | WP03 | P1 | No |
| T016 | Preserve item functionality and clean up | WP03 | P1 | No |
| T017 | Define types and create useItemsManager skeleton | WP04 | P2 | Yes |
| T018 | Implement search/sort/filter state | WP04 | P2 | No |
| T019 | Implement filtered+sorted items computation | WP04 | P2 | No |
| T020 | Implement selection state and handlers | WP04 | P2 | No |
| T021 | Create ItemsSection component skeleton | WP05 | P2 | No |
| T022 | Implement items list rendering | WP05 | P2 | No |
| T023 | Implement bulk action panel | WP05 | P2 | No |
| T024 | Integrate ItemsSection into space detail | WP05 | P2 | Yes |
| T025 | Integrate ItemsSection into transaction detail | WP05 | P2 | Yes |
| T026 | Create DetailRow component | WP06 | P3 | Yes |
| T027 | Adopt DetailRow in transaction DetailsSection | WP06 | P3 | Yes |
| T028 | Adopt DetailRow in item detail Details card | WP06 | P3 | Yes |
| T029 | Clean up duplicate detail row styles | WP06 | P3 | No |
| T030 | Verify MediaGallerySection on space detail | WP06 | P3 | Yes |
