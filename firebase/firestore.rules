rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isAccountMember(accountId) {
      return signedIn() &&
        exists(/databases/$(database)/documents/accounts/$(accountId)/users/$(request.auth.uid));
    }

    function isRequestCreate() {
      return request.resource.data.keys().hasOnly([
        'type',
        'status',
        'createdAt',
        'createdBy',
        'payload'
      ]) &&
      request.resource.data.status == 'pending' &&
      request.resource.data.type is string &&
      request.resource.data.createdBy == request.auth.uid &&
      request.resource.data.createdAt == request.time;
    }

    // Public-ish user profile document (example).
    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    // Account document (minimal shape for now).
    // NOTE: Account creation + membership creation is server-owned (Cloud Functions using Admin SDK).
    match /accounts/{accountId} {
      allow read: if isAccountMember(accountId);
      allow create: if false;

      // For now, account updates are server-managed (or future work).
      allow update, delete: if false;
    }

    // Account membership docs.
    // Membership docs are at: accounts/{accountId}/users/{uid}
    match /accounts/{accountId}/users/{uid} {
      allow read: if signedIn() && request.auth.uid == uid;
      allow create: if false;

      // For now, membership updates are server-managed (or future work).
      allow update, delete: if false;
    }

    // Quota counters should only be written by trusted server code (Cloud Functions).
    // Clients may read their own counters for UX, but server remains authoritative.
    match /users/{uid}/quota/{objectKey} {
      allow read: if signedIn() && request.auth.uid == uid;
      allow create, update, delete: if false;
    }

    // Example quota'd objects path. In real apps, map this to each feature's collection(s).
    // Recommended posture: write via Cloud Function so quotas/entitlements are enforced.
    match /users/{uid}/objects/{objectId} {
      allow read: if signedIn() && request.auth.uid == uid;
      allow create, update, delete: if false;
    }

    // Request-doc pattern (multi-doc correctness). These are scoped examples.
    // Adjust membership checks to your auth model (accounts, teams, etc.).
    match /accounts/{accountId}/projects/{projectId}/requests/{requestId} {
      allow read: if signedIn();
      allow create: if signedIn() && isRequestCreate();
      allow update, delete: if false;
    }

    match /accounts/{accountId}/inventory/requests/{requestId} {
      allow read: if signedIn();
      allow create: if signedIn() && isRequestCreate();
      allow update, delete: if false;
    }
  }
}

