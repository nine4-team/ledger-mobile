# Firebase Emulator Setup & Usage

This project uses the Firebase Emulator Suite for local development. This guide covers how to start the emulators with data persistence, seed data if necessary, and manage test users.

## üöÄ Quick Start

To start the emulators with automatic data persistence (saving/loading from `./firebase-export`):

```bash
./start-emulators.sh
```

This script will:
1.  Start Auth, Firestore, Functions, and Storage emulators.
2.  **Import** existing data from `./firebase-export` (if it exists).
3.  **Export** any new data to `./firebase-export` when you stop the process (Ctrl+C).

**Note:** Always use this script instead of `firebase emulators:start` directly to ensure your data is saved.

---

## üõ† Manual Data Seeding

If you need to reset the database or re-import fresh data from a migration export, follow these steps.

### 1. Seed Firestore Data

Imports the JSON bundle generated by the migration script into the `ledger-nine4` project.

```bash
node firebase/functions/scripts/seed-firestore-emulator.mjs \
  docs/data_migrator/out/v1/bundle.json \
  --project ledger-nine4
```

### 2. Seed Storage (Images)

Uploads media files from the migration export to the emulator bucket.

```bash
node firebase/functions/scripts/seed-storage-emulator.mjs \
  docs/data_migrator/out/v1/media-manifest.json \
  --project ledger-nine4
```

### 3. Create Test User

Creates a user in the Auth emulator with a specific UID (matching your seeded data).

```bash
# Usage: node create-auth-user.mjs <email> <password> <uid>
export FIREBASE_PROJECT_ID=ledger-nine4
node firebase/functions/scripts/create-auth-user.mjs \
  team@nine4.co \
  password123 \
  4ef35958-597c-4aea-b99e-1ef62352a72d
```

---

## ‚ö†Ô∏è Troubleshooting

### "No data in Emulator UI"
If you visit `http://localhost:4000/firestore` and see an empty database:
1.  Check the **Project ID** in the top dropdown or URL.
2.  Ensure it is set to **`ledger-nine4`**.
3.  Correct URL: `http://localhost:4000/firestore/ledger-nine4/data`

### Images not loading in App
1.  Ensure the Storage emulator is running (port 9199).
2.  Ensure you ran the **Seed Storage** script above.
3.  Reload the app (`Cmd+R` or `r`) to retry fetching images.

### "Offline" mode in App
If the app says "Offline" even when emulators are running:
1.  Check your `.env` file. Ensure `EXPO_PUBLIC_USE_FIREBASE_EMULATORS=true`.
2.  Ensure your device/simulator is on the same network as your computer.
3.  Restart the Metro bundler (`npx expo start --clear`).
